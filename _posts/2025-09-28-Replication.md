---
layout: post
title: What is Replication
date: 2025-09-28 18:00:00 +0300
categories: [Active Directory - CRTP, DCsync, Replication] # Add your new categories here
tags: [Replication, KCC, AD]
image: "photos/DCsync/Replication.jpg"
---

# DCsync

we need to understand Replication in order to perform DCsync Attack.

### What is Replication in Active Directory?

**Replication** is the process used between Domain Controllers (DCs) in an Active Directory environment to ensure they all have the same up-to-date database.

Every Domain Controller stores a copy of the Active Directory database.

- If one DC fails, others can still provide **authentication** and **authorization** services.
- This is why large organizations need multiple DCs that constantly replicate data.

**Example:**

If an administrator adds a new user on `DC1`, the same information must be replicated to `DC2` and `DC3`.

That way, if `DC1` goes down, the user can still log in through `DC2` because their credentials exist there as well.

so  any single change has been done on one of the DC will be replicated on the other DCs

The Active Directory database is stored in the file:

```
C:\Windows\ntds.dit
```

Any change in AD is written to this file, and then replicated across other DCs.

---

## How Replication Works

1. When a change happens on `DC1`, a **notification** is generated by the **KCC** (Knowledge Consistency Checker).
2. Other DCs see this notification and pull the update from `DC1`.
    
    > Important: Updates are pulled by DCs, not pushed automatically.
    > 

Replication can be **scheduled** (e.g., twice a day, before and after working hours) to reduce bandwidth impact.

By default, the KCC refreshes every **15 minutes**, or it can be triggered manually with:

```
repadmin /kcc
```

---

## Active Directory Partitions

The **`ntds.dit`** file contains four partitions:

1. **Domain Partition** – Stores objects, containers, and domain information.
2. **Configuration Partition** – Stores sites, services, and AD configuration.
    - Same site: replication happens every 7–15 seconds.
    - Different sites: every 180 minutes.
3. **Schema Partition** – Defines object classes and attributes.
4. **Application Partition** – Used for DNS replication:
    1. To all DNS servers in the forest.
    2. To all DNS servers in the domain.

---

## Types of Replication

1. **Intra-site** – Between DCs within the same site.
2. **Inter-site** – Between DCs across different sites.

---

## Single Master vs Multi-Master

- **Single Master:**
    
    If there’s only one DC in the domain, no replication occurs (no second DC to sync with).
    
- **Multi-Master:**
    
    If multiple DCs exist and all are writable, replication occurs across all of them.
    

---

## Tricks and Notes

- If a **user is moved to an OU** and that OU is deleted on another DC, the user object ends up in the **LostAndFound** container.
- **Replication conflicts and versioning:**
    - Every object has:
        - **Version Number** – the edit version.
        - **Timestamp** – time of the change.
        - **DC GUID** – the identifier of the DC that made the change.
    - The newest update (version + timestamp) wins and replicates to other DCs.
- **Indirect Replication:**
    
    Example with **DC1, DC2, DC3**:
    
    - DC1 and DC3 are not directly connected.
    - DC2 is connected to both.
    - Updates flow from DC1 → DC2 → DC3.

